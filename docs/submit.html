<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作品提出フォーム</title>
  <style>
    body { font-family: "Yu Gothic", sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; }
    input, textarea, button { width: 100%; padding: 8px; margin-top: 5px; }
    .preview { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
    .instructions { background: #f9f9f9; padding: 10px; border-left: 4px solid #4CAF50; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>作品提出フォーム</h1>

  <label>名前（作者名）</label>
  <input type="text" id="name" placeholder="例：たなかはなこ">

  <label>作品タイトル</label>
  <input type="text" id="title" placeholder="例：あきのかぜ">

  <label>コメント（任意）</label>
  <textarea id="comment" placeholder="作品への思いや工夫など"></textarea>

  <label>作品ファイル（JSON）</label>
  <input type="file" id="fileInput" accept=".json">

  <button onclick="submitWork()">作品を確認する</button>

  <div class="preview" id="preview" style="display:none;"></div>

  <div class="instructions">
    <h3>📮 提出方法</h3>
    <p>「JSON形式でダウンロード」ボタンを押して、作品ファイルを保存してください。</p>
    <p>保存されたファイル名は「作品タイトル_作者名.json」の形式になります（ローマ字変換済み）。</p>
    <p>保存したファイルを、以下のいずれかの方法で先生に提出してください：</p>
    <ul>
      <li>学校の共有フォルダにアップロード</li>
      <li>メールで送信（件名に名前と作品タイトルを記入）</li>
      <li>Googleフォームがある場合は、ファイル添付して提出</li>
    </ul>
    <p>提出された作品は、ギャラリーに掲載されます✨</p>
  </div>

  <script>
    function submitWork() {
      const name = document.getElementById("name").value.trim();
      const title = document.getElementById("title").value.trim();
      const comment = document.getElementById("comment").value.trim();
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");

      if (!name || !title || fileInput.files.length === 0) {
        alert("名前・タイトル・作品ファイルは必須です");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = JSON.parse(event.target.result);
          data.name = name;
          data.title = title;
          data.comment = comment;

          const jsonText = JSON.stringify(data, null, 2);
          preview.style.display = "block";
          const filename = generateSafeFilename(title, name);
          preview.innerHTML = `
            <h3>提出内容プレビュー</h3>
            <pre>${jsonText}</pre>
            <button onclick='downloadJSON("${filename}", ${JSON.stringify(data)})'>JSON形式でダウンロード</button>
          `;
        } catch (err) {
          alert("JSONファイルの読み込みに失敗しました");
        }
      };
      reader.readAsText(fileInput.files[0]);
    }

    function toRomaji(str) {
      const kanaMap = {
        あ:"a", い:"i", う:"u", え:"e", お:"o",
        か:"ka", き:"ki", く:"ku", け:"ke", こ:"ko",
        さ:"sa", し:"shi", す:"su", せ:"se", そ:"so",
        た:"ta", ち:"chi", つ:"tsu", て:"te", と:"to",
        な:"na", に:"ni", ぬ:"nu", ね:"ne", の:"no",
        は:"ha", ひ:"hi", ふ:"fu", へ:"he", ほ:"ho",
        ま:"ma", み:"mi", む:"mu", め:"me", も:"mo",
        や:"ya", ゆ:"yu", よ:"yo",
        ら:"ra", り:"ri", る:"ru", れ:"re", ろ:"ro",
        わ:"wa", を:"wo", ん:"n",
        が:"ga", ぎ:"gi", ぐ:"gu", げ:"ge", ご:"go",
        ざ:"za", じ:"ji", ず:"zu", ぜ:"ze", ぞ:"zo",
        だ:"da", ぢ:"ji", づ:"zu", で:"de", ど:"do",
        ば:"ba", び:"bi", ぶ:"bu", べ:"be", ぼ:"bo",
        ぱ:"pa", ぴ:"pi", ぷ:"pu", ぺ:"pe", ぽ:"po"
      };
      return str.split("").map(c => kanaMap[c] || "_").join("");
    }

    function generateSafeFilename(title, name) {
      const romajiTitle = toRomaji(title);
      const romajiName = toRomaji(name);
      return `${romajiTitle}_${romajiName}`;
    }

    function downloadJSON(filename, data) {
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${filename}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>

