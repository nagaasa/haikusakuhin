<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作品提出フォーム</title>
  <style>
    body { font-family: "Yu Gothic", sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; }
    input, textarea, button { width: 100%; padding: 8px; margin-top: 5px; }
    .preview { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
    .instructions { background: #f9f9f9; padding: 10px; border-left: 4px solid #4CAF50; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>作品提出フォーム</h1>

  <label>名前（作者名）</label>
  <input type="text" id="name" placeholder="例：田中花子">

  <label>作品タイトル</label>
  <input type="text" id="title" placeholder="例：秋の風">

  <label>コメント（任意）</label>
  <textarea id="comment" placeholder="作品への思いや工夫など"></textarea>

  <label>作品ファイル（JSON）</label>
  <input type="file" id="fileInput" accept=".json">

  <button onclick="submitWork()">作品を確認する</button>

  <div class="preview" id="preview" style="display:none;"></div>

  <div class="instructions">
    <h3>📮 提出方法</h3>
    <p>「JSON形式でダウンロード」ボタンを押して、作品ファイルを保存してください。</p>
    <p>保存されたファイル名は「作品タイトル_作者名.json」の形式になります（英数字のみ）。</p>
    <p>保存したファイルを、以下のいずれかの方法で先生に提出してください：</p>
    <ul>
      <li>学校の共有フォルダにアップロード</li>
      <li>メールで送信（件名に名前と作品タイトルを記入）</li>
      <li>Googleフォームがある場合は、ファイル添付して提出</li>
    </ul>
    <p>提出された作品は、ギャラリーに掲載されます✨</p>
  </div>

  <script>
    function submitWork() {
      const name = document.getElementById("name").value.trim();
      const title = document.getElementById("title").value.trim();
      const comment = document.getElementById("comment").value.trim();
      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");

      if (!name || !title || fileInput.files.length === 0) {
        alert("名前・タイトル・作品ファイルは必須です");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const data = JSON.parse(event.target.result);
          data.name = name;
          data.title = title;
          data.comment = comment;

          const jsonText = JSON.stringify(data, null, 2);
          preview.style.display = "block";
          preview.innerHTML = `
            <h3>提出内容プレビュー</h3>
            <pre>${jsonText}</pre>
            <button onclick='downloadJSON("${generateSafeFilename(title, name)}", ${JSON.stringify(data)})'>JSON形式でダウンロード</button>
          `;
        } catch (err) {
          alert("JSONファイルの読み込みに失敗しました");
        }
      };
      reader.readAsText(fileInput.files[0]);
    }

    function generateSafeFilename(title, name) {
      const safeTitle = title.replace(/[^\w\-]/g, "_");
      const safeName = name.replace(/[^\w\-]/g, "_");
      return `${safeTitle}_${safeName}`;
    }

    function downloadJSON(filename, data) {
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `${filename}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>

